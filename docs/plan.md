# Spec-Flow Studio 実装計画

## 目的・スコープ・制約

> [!IMPORTANT]
> 以下の内容は人間の承認なしに変更してはならない。変更が必要な場合は「変更提案」セクションに記述すること。

### 目的

Spec-Flow Studioは、AIワークフローを可視化・制御するためのPWAアプリケーションである。
Spec-Kit形式で仕様を記述し、AIが自動的に以下を生成する：

- UIモック
- API仕様
- テストケース
- ユースケース図

Aether Console（SF風司令室）と連携し、「AIをどう制御するか」を可視化できるデモンストレーションツールとなる。

### スコープ

**含めるもの:**
- Spec-Kitエディタ（YAML形式エージェント仕様の編集）
- AI生成エンジン（Gemini APIによる自動生成）
- 生成物ビューア（PWAで一覧表示）
- 差分管理（SpecPatch作成・適用・履歴）
- Aether Console連携（WebSocket双方向通信）

**含めないもの（Phase 1では）:**
- 複雑なユーザー認証
- マルチテナント対応
- サーバーサイドでの永続化（localStorageで代替）

### 制約

1. **技術スタック**: SvelteKit + TypeScript + Vanilla CSS
2. **デプロイ**: GitHub Pages（Phase 1-2）→ Vercel（Phase 3）
3. **AI API**: Gemini API を使用
4. **連携プロトコル**: `integration.ts` で定義された型を厳守

---

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    Spec-Flow Studio                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │ Spec Editor │  │ AI Generator │  │ Artifact Viewer    │ │
│  │ (Desired)   │→ │ (Gemini)    │→ │ (Actual)           │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
│         ↑                                    ↓              │
│  ┌─────────────────────────────────────────────────────────┐│
│  │         Diff Manager (SpecPatch) - Drift検出           ││
│  └─────────────────────────────────────────────────────────┘│
│                           ↕                                 │
│  ┌─────────────────────────────────────────────────────────┐│
│  │         Integration Layer (WebSocket)                   ││
│  └─────────────────────────────────────────────────────────┘│
│                           ↕                                 │
└─────────────────────────────────────────────────────────────┘
                           ↕
              ┌────────────────────────┐
              │    Aether Console      │
              │   (SF風AI司令室)       │
              └────────────────────────┘
```

### 状態管理の3層モデル

| レイヤー | 説明 | 対応UI |
|---------|------|--------|
| **Desired State** | Spec-Kit（YAML仕様） | エディタ |
| **Actual State** | 生成されたArtifacts | ビューア |
| **Drift** | 両者の乖離・パッチ履歴 | 履歴ページ |

---

## Phase 1: 基盤構築（目標: 1週間）

**目標**: プロジェクト基盤・デザインシステム・基本レイアウトの完成

### タスク

| # | タスク | 詳細 |
|---|--------|------|
| 1.1 | プロジェクト構成整理 | ディレクトリ構造、型定義、stores配置 |
| 1.2 | 共通型定義 | `integration.ts` を `$lib/types` へ移動・拡張 |
| 1.3 | デザインシステム | SF風CSS変数、共通コンポーネント |
| 1.4 | 基本レイアウト | サイドバー + メインエリア + ステータスバー |
| 1.5 | PWA設定 | manifest.json, service worker |
| 1.6 | ルーティング | `/editor`, `/viewer`, `/history`, `/settings` |
| 1.7 | ダッシュボード初期表示 | 現在のSpec名、Artifact一覧、接続状態 |

### ディレクトリ構成（予定）

```
src/
├── lib/
│   ├── components/     # 共通コンポーネント
│   │   ├── ui/         # 基本UI (Button, Panel, etc.)
│   │   ├── editor/     # エディタ関連
│   │   └── viewer/     # ビューア関連
│   ├── stores/         # Svelte stores
│   │   ├── spec-store.ts
│   │   ├── artifact-store.ts
│   │   └── integration-store.ts
│   ├── types/          # TypeScript型定義
│   │   └── index.ts    # integration.ts の内容を含む
│   ├── services/       # 外部連携
│   │   ├── ai-service.ts
│   │   └── ws-service.ts
│   └── utils/          # ユーティリティ
├── routes/
│   ├── +layout.svelte
│   ├── +page.svelte    # ダッシュボード
│   ├── editor/         # Spec-Kit エディタ
│   ├── viewer/         # 生成物ビューア
│   ├── history/        # 差分履歴
│   └── settings/       # 設定
└── app.css             # グローバルスタイル
```

---

## Phase 2: Spec-Kit エディタ（目標: 1週間）

**目標**: YAMLでエージェント仕様を編集できるエディタの完成

### タスク

| # | タスク | 詳細 |
|---|--------|------|
| 2.1 | YAMLパーサー統合 | js-yaml + シンタックスハイライト |
| 2.2 | エディタUI | CodeMirror or Monaco Editor |
| 2.3 | バリデーション | Spec-Kit形式のスキーマ検証 |
| 2.4 | **制約可視化パネル** | constraints を別パネルで強調表示 |
| 2.5 | テンプレート | エージェント定義のテンプレート |
| 2.6 | ローカル保存 | localStorage への保存・読込 |
| 2.7 | プレビュー | YAML → 構造化ビュー |

---

## Phase 3.0: AI生成エンジン・コア（目標: 1週間）

**目標**: UIモックとAPI仕様の自動生成

### タスク

| # | タスク | 詳細 |
|---|--------|------|
| 3.0.1 | Gemini API統合 | APIキー管理、リクエスト処理 |
| 3.0.2 | プロンプト設計（コア） | UIモック・API仕様用テンプレート |
| 3.0.3 | UIモック生成 | HTML/CSSコード生成 |
| 3.0.4 | API仕様生成 | OpenAPI形式で出力（Structured Output活用） |
| 3.0.5 | 生成ログ保存 | 使用Spec、生成理由（rationale）を記録 |

---

## Phase 3.5: AI生成エンジン・拡張（目標: 1週間）

**目標**: テストケース・ユースケース図の生成とストリーミング対応

### タスク

| # | タスク | 詳細 |
|---|--------|------|
| 3.5.1 | プロンプト設計（拡張） | Test・UC用テンプレート |
| 3.5.2 | テストケース生成 | Jest/Vitest形式で出力 |
| 3.5.3 | ユースケース図生成 | Mermaid形式で出力 |
| 3.5.4 | Mermaidレンダリング | mermaid.js統合 |
| 3.5.5 | ストリーミング対応 | 生成中のリアルタイム表示 |

---

## Phase 4: 差分管理・連携（目標: 2週間）

**目標**: 差分管理とAether Console連携

### タスク

| # | タスク | 詳細 |
|---|--------|------|
| 4.1 | SpecDiff生成 | 仕様変更の差分検出 |
| 4.2 | SpecPatch管理 | パッチの作成・適用・履歴 |
| 4.3 | 差分ビジュアライズ | 変更箇所のハイライト表示 |
| 4.4 | WebSocket実装 | Aether Consoleとの通信基盤 |
| 4.5 | イベント送受信 | ConsoleToStudioEvent / StudioToConsoleEvent |
| 4.6 | 同期機能 | 仕様・パッチの自動同期 |
| 4.7 | **Rollback機能** | 任意のSpecPatchまで仕様を巻き戻し |

---

## 成果物一覧

| Phase | 成果物 | 説明 |
|-------|--------|------|
| 1 | 基本レイアウト | SF風PWAシェル |
| 2 | Spec-Kitエディタ | YAML編集UI + 制約可視化 |
| 3.0 | AI生成（コア） | UIモック + API仕様 |
| 3.5 | AI生成（拡張） | Test + UC + ストリーミング |
| 4 | 差分管理・連携 | Aether Console連携 + Rollback |

---

## 関連ドキュメント

- [spec-patch-format.md](./spec-patch-format.md) - SpecPatch形式の定義

---

## 変更提案

（現時点では提案なし）

---

## 承認履歴

| 日付 | 承認者 | 内容 |
|------|--------|------|
| 2026-01-15 | ChatGPT / Gemini | 外部AIレビュー完了・GO判断 |
| 2026-01-15 | ユーザー | Phase分割・SpecPatch形式・AI静的解析延期を承認 |
